<!DOCTYPE html>
<html lang="ja">

<head>
	<title>Rail Cutting Thing</title>
	<style>
		.rail_default {
			fill: white;
		}
		.rail_waste {
			fill: red;
		}
		.rail_product {
			fill: green;
		}
		.rail_hole {
			fill: black;
		}
	</style>
</head>

<body>
	<a href="https://docs.google.com/document/d/1X0tniovY9GFS8utf_hrDHkxwIIPgNGg1HFsa_gX3pOw/edit?usp=sharing">Part number breakdown</a>
	<h3>Rail Pitch</h3>
	<input type="number" id="rail_pitch" style="background-color=#8cd9b3;color:#000000;" value="60"/>
	<hr>
	<p>(Ignore) will calculate a default value for the E-dimensions without considering anything else.</p>
	<p>(Custom) will force the rail to use the specified input value./p>
	<p>(Minimum) will add a half-pitch length of rail if the calculated default E-dimension is smaller than the input value./p>
	<hr>
	<table>
		<tr>
			<th></th>
			<th>Stock Rail</th>
			<th>Desired Rail</th>
		</tr>
		<tr>
			<th>Length</th>
			<th><input type="number" id="stock_length" style="background-color=#8cd9b3;color:#000000;" value="600"/></th>
			<th><input type="number" id="desired_length" style="background-color=#8cd9b3;color:#000000;" value="200"/></th>
		</tr>
		<tr>
			<th>E1-Dimension</th>
			<th><input type="number" id="stock_e1" style="background-color=#8cd9b3;color:#000000;" value="0"/></th>
			<th><input type="number" id="desired_e1" style="background-color=#8cd9b3;color:#000000;" value="0"/></th>
		</tr>
		<tr>
			<th>E1-Options</th>
			<th width="40%">
				<input type="radio" id="radio_e1_input_ignore" name="radio_e1_input" value="E1_Input_Ignore" checked="checked">
				<label for="radio_e1_input_ignore" style="font-size:80%">Ignore</label>
				<br>
				<input type="radio" id="radio_e1_input_custom" name="radio_e1_input" value="E1_Input_Custom">
				<label for="radio_e1_input_custom" style="font-size:80%">Custom</label>
				<br>
				<input type="radio" id="radio_e1_input_minimum" name="radio_e1_input" value="E1_Input_Minimum">
				<label for="radio_e1_input_minimum" style="font-size:80%">Minimum</label>
				<br>
			</th>
			<th width="40%">
				<input type="radio" id="radio_e1_output_ignore" name="radio_e1_output" value="E1_Output_Ignore" checked="checked">
				<label for="radio_e1_output_ignore" style="font-size:80%">Ignore</label>
				<br>
				<input type="radio" id="radio_e1_output_custom" name="radio_e1_output" value="E1_Output_Custom">
				<label for="radio_e1_output_custom" style="font-size:80%">Custom</label>
				<br>
				<input type="radio" id="radio_e1_output_minimum" name="radio_e1_output" value="E1_Output_Minimum">
				<label for="radio_e1_output_minimum" style="font-size:80%">Minimum</label>
				<br>
			</th>
		</tr>
	</table>
	<hr>
	<button id="button_calculator" onclick="document.getElementById('output_value').innerHTML = perform_cuts()">Run</button>
	<p>Please note that this program cannot account for the minimum e-dimensions for parts. The user is responsible for making sure the rail complies with these minimum e-dimensions.</p>
	<h4>Number of desired rails that can be made from the stock rail:</h4>
	
	<svg xmlns="http://www.w3.org/2000/svg" id="svg_rail_render" height="50" width="1000"/>
	
	<pre id="output_value"/>
</body>

<script>
	
	class rail{
		
		// Meta-methods ////////////////////////////////////////////////////////////////
		
		constructor(length, e1, pitch){
			this.length = length;
			this.pitch = pitch;
			this.e1 = e1;
			this.rail_children = [];
			this.rail_class = "rail_default";
		}
		
		get e2(){ return (this.length - this.e1)%this.pitch == 0 ? this.pitch : (this.length - this.e1)%this.pitch; }
		
		get last_rail() { return this.rail_children.length == 0 ? this : this.rail_children[this.rail_children.length - 1].last_rail; }
		
		get_waste_rail(waste_length = 0) {
			// If this rail has no children, it is one of the final products.
			if(this.rail_children.length == 0){
				if(this.rail_class == "rail_waste"){ return waste_length + this.length; }
				return waste_length;
			}
			
			// Iterate through the children and perform the same operations.
			for(let rail_child in this.rail_children){ waste_length = this.rail_children[rail_child].get_waste_rail(waste_length); }
			return waste_length;
		}
		
		get_product_rails(product_count = 0){
			// If this rail has no children, it is one of the final products.
			if(this.rail_children.length == 0){
				if(this.rail_class == "rail_product"){ return product_count + 1; }
				return product_count;
			}
			
			// Iterate through the children and perform the same operations.
			for(let rail_child in this.rail_children){ product_count = this.rail_children[rail_child].get_product_rails(product_count); }
			return product_count;
		}
		
		// Methods ////////////////////////////////////////////////////////////////
		
		serialize_rails(return_array = []) { // collect all the rails with no rail_children, aka all the pieces left at the end.
			if(this.rail_children.length === 0){ return_array.push(this); return return_array; } // if there are no more rail_children, push this rail onto the return array. This happens first so we keep the rails in-order.
			for(let rail_child in this.rail_children) { this.rail_children[rail_child].serialize_rails(return_array); } // recursive call, handing down the return_array, gathering all the rails with no rail_children.
			return return_array;
		} // end of method serialize_rails
		
		cut_rail(distance_from_left_end_to_cut){ // Return whether the cut was successful.
		
			if(distance_from_left_end_to_cut > this.length) { return false; }
			
			this.rail_children.push( new rail( // First rail starts at the left end and ends at the length of the cut.
					distance_from_left_end_to_cut, // length will always be this
					Math.min(this.e1, distance_from_left_end_to_cut), // if this.e1 is smaller than the cut length, then the e1 is the same. Otherwise, it's just the cut length.
					this.pitch)); // Pitch always matches
					
			this.rail_children.push( new rail( // Second rail starts at the length of the cut, and ends at the other end of the rail.
					this.length - distance_from_left_end_to_cut, // length is always the original length minus the cut length
					Math.min(this.length - distance_from_left_end_to_cut, (this.length - distance_from_left_end_to_cut - this.e2)%this.pitch), // if the cut makes a shorter second rail than the original e2, then e2 is just that length, otherwise, just the original e2
					this.pitch)); // Pitch always matches.
			
			return true;
		} // end of method cut_rail
		
		make_rail(desired_rail){ // Cut the rail as ordered. Return whether the desired rail was able to be made.
		
			// Perform the cuts. If either fails, roll back the rail_children array to exclude any new cuts, since the desired rail isn't possible.
			if( this.cut_rail( // if the desired rail's e1 is longer than the stock's, have to add a pitch to get the correct cut length.
					this.e1 - desired_rail.e1 < 0 ? 
					this.e1 - desired_rail.e1 + this.pitch : 
					this.e1 - desired_rail.e1)){
					
				//If the cut in the if statement succeeded, then we can do this stuff
				this.rail_children[0].rail_class = "rail_waste"; // assign the left piece red, waste rail
				
				if(this.rail_children[1].cut_rail(desired_rail.length)){
					this.rail_children[1].rail_children[0].rail_class = "rail_product"; // desired rail
					this.rail_children[1].rail_children[1].rail_class = "rail_waste"; // waste/remaining rail
				} else { this.rail_children = []; return false; } // Roll back the rail_children array if the cut cannot be completed.
			} else { return false; }
			return true;
		} // End of method make_rail
		
		render_rail(){
			const svgns = "http://www.w3.org/2000/svg";
			const svg_document_element = document.getElementById("svg_rail_render");
			
			let svg_x = 0;
			let rail_cut_list = this.serialize_rails();
			svg_document_element.setAttribute("width", this.length);
			
			for(let rail_piece in rail_cut_list){
				// Create the new rectangle and apply all the parameters to correctly place and define it.
				let newRectangle = document.createElementNS(svgns, "rect");
				newRectangle.setAttribute("class", rail_cut_list[rail_piece].rail_class);
				newRectangle.setAttribute("x", svg_x);
				newRectangle.setAttribute("y", 0);
				newRectangle.setAttribute("width", rail_cut_list[rail_piece].length);
				newRectangle.setAttribute("height", svg_document_element.getBoundingClientRect().height);
				svg_document_element.appendChild(newRectangle);
				
				// Set the starting poitn to be the end of the current rail.
				svg_x += rail_cut_list[rail_piece].length;
			}
			
			//Add the pitch holes
			while( svg_x >= 0 ){ 
				// Create the circle and apply the parameters to correctly place and define it.
				let newCircle = document.createElementNS(svgns, "circle");
				newCircle.setAttribute("style", "fill: black;");
				newCircle.setAttribute("cx", svg_x - this.e2);
				newCircle.setAttribute("cy", 0.5*svg_document_element.getBoundingClientRect().height);
				newCircle.setAttribute("r", 0.15*svg_document_element.getBoundingClientRect().height);
				svg_document_element.appendChild(newCircle);
				
				// decrement the length by the pitch each time
				svg_x += -1*this.pitch;
			}
		} // End of method render_rail
		
		perform_maximum_cuts(desired_rail){
			while(this.last_rail.make_rail(desired_rail)){}
			this.render_rail();
			return `Produced ${this.get_product_rails()} rails, cutting off ${this.get_waste_rail()} mm of length.\nOutput rail's e-dimension is ${this.e1} mm.`;
		}
		
	} // End of class rail
	
	function getDimensions(){
	
		// Start by assuming the e-dimensions in the fields are specific e-dimensions requested.
		let dataset = [+document.getElementById("rail_pitch").value,
			[+document.getElementById("stock_length").value, +document.getElementById("stock_e1").value],
			[+document.getElementById("desired_length").value, +document.getElementById("desired_e1").value]];	
		
		// If the custom radio is not selected, then first overwrite the value with the default calculated one.
		if(!document.getElementById("radio_e1_input_custom").checked){
			dataset[1][1] = parseFloat((dataset[1][0]%dataset[0])/2 == 0 ? dataset[0]/2 : ((dataset[1][0]%dataset[0])/2).toFixed(3));
			
			// Then, check to see if the entered value is specified as a minimum e-dimension, in which case add half a pitch to the end if the default e-dim is lower than the specified minimum.
			if(document.getElementById("radio_e1_input_minimum").checked && +document.getElementById("stock_e1").value > dataset[1][1]){
				dataset[1][1] = dataset[1][1] + dataset[0]/2
			}
		}
		
		// Do the same for the output rail.
		if(!document.getElementById("radio_e1_output_custom").checked){
			dataset[2][1] = parseFloat((dataset[2][0]%dataset[0])/2 == 0 ? dataset[0]/2 : ((dataset[2][0]%dataset[0])/2).toFixed(3));
		
			if(document.getElementById("radio_e1_output_minimum").checked && +document.getElementById("desired_e1").value > dataset[2][1]){
				dataset[2][1] = dataset[2][1] + dataset[0]/2
			}
		}
		
		
		return dataset;
	}
	
	function perform_cuts(){
		let dataset = getDimensions(); // [Pitch, [Stock length, stock e1], [desired length, desired e1]]
		
		let error_check = [
			[dataset[0] <= 0, "Please enter a positive number for the pitch."],
			[dataset[1][0] <= 0, "Please enter a positive number for the input rail length."],
			[dataset[1][1] < 0, "Please enter a positive number for the input rail E1."],
			[dataset[2][0] <= 0, "Please enter a positive number for the output rail length."],
			[dataset[2][1] < 0, "Please enter a positive number for the pitch output rail E1."],
			[dataset[1][1] >= dataset[0], "End-dimension of the input rail cannot exceed the pitch."],
			[dataset[2][1] >= dataset[0], "End-dimension of the output rail cannot exceed the pitch."],
			[dataset[1][0] < dataset[2][0], "Input rail length must be at least as long as the output rail length."]			
		];
		let error_string = error_check.reduce((previousValue, currentValue) => (currentValue[0] == true) ? previousValue + "\n" + currentValue[1] : previousValue, "");
		if(error_string != ""){ return `Error:\n${error_string}`; }
		
		let rail_stock = new rail(dataset[1][0],dataset[1][1],dataset[0]); // rail(Length, e1, pitch)
		let rail_desired = new rail(dataset[2][0],dataset[2][1],dataset[0]);
		return rail_stock.perform_maximum_cuts(rail_desired);
	}
	
</script>

</html>